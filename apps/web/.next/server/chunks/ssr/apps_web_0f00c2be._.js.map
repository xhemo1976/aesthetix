{"version":3,"sources":["../../../../../../apps/web/lib/actions/reminders.ts","../../../../../../apps/web/.next-internal/server/app/dashboard/reminders/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server'\n\nimport { createClient } from '@/lib/supabase/server'\nimport { revalidatePath } from 'next/cache'\n\nexport type AppointmentForReminder = {\n  id: string\n  start_time: string\n  end_time: string\n  status: string\n  reminder_sent_at: string | null\n  customer: {\n    id: string\n    first_name: string\n    last_name: string\n    phone: string | null\n    email: string | null\n  }\n  service: {\n    id: string\n    name: string\n    duration_minutes: number\n  }\n  employee: {\n    first_name: string\n    last_name: string\n  } | null\n}\n\nexport type TenantInfo = {\n  name: string\n  whatsapp_number: string | null\n}\n\n/**\n * Get appointments that need reminders (tomorrow's appointments)\n */\nexport async function getAppointmentsForReminders(): Promise<{\n  appointments: AppointmentForReminder[]\n  tenant: TenantInfo | null\n  error: string | null\n}> {\n  const supabase = await createClient()\n\n  // Get current user's tenant\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) {\n    return { appointments: [], tenant: null, error: 'Nicht authentifiziert' }\n  }\n\n  const { data: profile } = await supabase\n    .from('users')\n    .select('tenant_id, tenants(name, whatsapp_number)')\n    .eq('id', user.id)\n    .single()\n\n  if (!profile?.tenant_id) {\n    return { appointments: [], tenant: null, error: 'Kein Tenant gefunden' }\n  }\n\n  // Calculate tomorrow's date range\n  const now = new Date()\n  const tomorrow = new Date(now)\n  tomorrow.setDate(tomorrow.getDate() + 1)\n  tomorrow.setHours(0, 0, 0, 0)\n\n  const dayAfterTomorrow = new Date(tomorrow)\n  dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1)\n\n  // Get tomorrow's appointments that haven't been reminded yet\n  const { data: appointments, error } = await supabase\n    .from('appointments')\n    .select(`\n      id,\n      start_time,\n      end_time,\n      status,\n      reminder_sent_at,\n      customers (\n        id,\n        first_name,\n        last_name,\n        phone,\n        email\n      ),\n      services (\n        id,\n        name,\n        duration_minutes\n      ),\n      employees (\n        first_name,\n        last_name\n      )\n    `)\n    .eq('tenant_id', profile.tenant_id)\n    .in('status', ['scheduled', 'confirmed'])\n    .gte('start_time', tomorrow.toISOString())\n    .lt('start_time', dayAfterTomorrow.toISOString())\n    .order('start_time', { ascending: true })\n\n  if (error) {\n    console.error('Error fetching appointments for reminders:', error)\n    return { appointments: [], tenant: null, error: error.message }\n  }\n\n  // Transform the data - handle both array and single object response from Supabase\n  const transformedAppointments: AppointmentForReminder[] = (appointments || []).map(apt => {\n    const customer = Array.isArray(apt.customers) ? apt.customers[0] : apt.customers\n    const service = Array.isArray(apt.services) ? apt.services[0] : apt.services\n    const employee = Array.isArray(apt.employees) ? apt.employees[0] : apt.employees\n\n    return {\n      id: apt.id,\n      start_time: apt.start_time,\n      end_time: apt.end_time,\n      status: apt.status,\n      reminder_sent_at: apt.reminder_sent_at,\n      customer: customer as AppointmentForReminder['customer'],\n      service: service as AppointmentForReminder['service'],\n      employee: employee as AppointmentForReminder['employee'] | null\n    }\n  })\n\n  const tenantInfo = profile.tenants as unknown as TenantInfo\n\n  return {\n    appointments: transformedAppointments,\n    tenant: tenantInfo,\n    error: null\n  }\n}\n\n/**\n * Get all appointments for a specific date range (for filtering)\n */\nexport async function getAppointmentsByDateRange(\n  startDate: Date,\n  endDate: Date\n): Promise<{\n  appointments: AppointmentForReminder[]\n  tenant: TenantInfo | null\n  error: string | null\n}> {\n  const supabase = await createClient()\n\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) {\n    return { appointments: [], tenant: null, error: 'Nicht authentifiziert' }\n  }\n\n  const { data: profile } = await supabase\n    .from('users')\n    .select('tenant_id, tenants(name, whatsapp_number)')\n    .eq('id', user.id)\n    .single()\n\n  if (!profile?.tenant_id) {\n    return { appointments: [], tenant: null, error: 'Kein Tenant gefunden' }\n  }\n\n  const { data: appointments, error } = await supabase\n    .from('appointments')\n    .select(`\n      id,\n      start_time,\n      end_time,\n      status,\n      reminder_sent_at,\n      customers (\n        id,\n        first_name,\n        last_name,\n        phone,\n        email\n      ),\n      services (\n        id,\n        name,\n        duration_minutes\n      ),\n      employees (\n        first_name,\n        last_name\n      )\n    `)\n    .eq('tenant_id', profile.tenant_id)\n    .in('status', ['scheduled', 'confirmed'])\n    .gte('start_time', startDate.toISOString())\n    .lt('start_time', endDate.toISOString())\n    .order('start_time', { ascending: true })\n\n  if (error) {\n    console.error('Error fetching appointments:', error)\n    return { appointments: [], tenant: null, error: error.message }\n  }\n\n  const transformedAppointments: AppointmentForReminder[] = (appointments || []).map(apt => {\n    const customer = Array.isArray(apt.customers) ? apt.customers[0] : apt.customers\n    const service = Array.isArray(apt.services) ? apt.services[0] : apt.services\n    const employee = Array.isArray(apt.employees) ? apt.employees[0] : apt.employees\n\n    return {\n      id: apt.id,\n      start_time: apt.start_time,\n      end_time: apt.end_time,\n      status: apt.status,\n      reminder_sent_at: apt.reminder_sent_at,\n      customer: customer as AppointmentForReminder['customer'],\n      service: service as AppointmentForReminder['service'],\n      employee: employee as AppointmentForReminder['employee'] | null\n    }\n  })\n\n  const tenantInfo = profile.tenants as unknown as TenantInfo\n\n  return {\n    appointments: transformedAppointments,\n    tenant: tenantInfo,\n    error: null\n  }\n}\n\n/**\n * Mark a reminder as sent\n */\nexport async function markReminderSent(appointmentId: string): Promise<{\n  success: boolean\n  error: string | null\n}> {\n  const supabase = await createClient()\n\n  const { error } = await supabase\n    .from('appointments')\n    .update({ reminder_sent_at: new Date().toISOString() })\n    .eq('id', appointmentId)\n\n  if (error) {\n    console.error('Error marking reminder as sent:', error)\n    return { success: false, error: error.message }\n  }\n\n  revalidatePath('/dashboard/reminders')\n  return { success: true, error: null }\n}\n\n/**\n * Reset reminder status (for re-sending)\n */\nexport async function resetReminderStatus(appointmentId: string): Promise<{\n  success: boolean\n  error: string | null\n}> {\n  const supabase = await createClient()\n\n  const { error } = await supabase\n    .from('appointments')\n    .update({ reminder_sent_at: null })\n    .eq('id', appointmentId)\n\n  if (error) {\n    console.error('Error resetting reminder status:', error)\n    return { success: false, error: error.message }\n  }\n\n  revalidatePath('/dashboard/reminders')\n  return { success: true, error: null }\n}\n","export {logout as '00ea5d6db9aa78d155ad7148c00d987a78197cad0e'} from 'ACTIONS_MODULE0'\nexport {login as '40557600bffd5a2c9eccc9fb8b66b41ea0de68fa87'} from 'ACTIONS_MODULE0'\nexport {signup as '40edf544285d63aedbf98dd3fd472b99b616040b0a'} from 'ACTIONS_MODULE0'\nexport {getAppointmentsForReminders as '00bebf577dc65e572ab36782e986e4b2ef68bb217c'} from 'ACTIONS_MODULE1'\nexport {resetReminderStatus as '407a1e933d7f007ae1a21a263462f272ea6055ee79'} from 'ACTIONS_MODULE1'\nexport {markReminderSent as '40fac9818d250a2754794c3fb55beaf18ccf7085a0'} from 'ACTIONS_MODULE1'\nexport {getAppointmentsByDateRange as '60c55c83feabba07200565570d40e535845c54067f'} from 'ACTIONS_MODULE1'\nexport {markReminderSent as '40fac9818d250a2754794c3fb55beaf18ccf7085a0'} from 'ACTIONS_MODULE1'\nexport {resetReminderStatus as '407a1e933d7f007ae1a21a263462f272ea6055ee79'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"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"}